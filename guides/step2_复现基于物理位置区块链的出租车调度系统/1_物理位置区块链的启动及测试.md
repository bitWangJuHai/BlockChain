### 物理位置区块链的启动及测试
> `geth1.9.12`或`geth1`的大部分行为和`geth`类似，若无明显不同笔者将不在此进行赘述，详细请参考`step1_官方版本以太坊的使用`
#### 确认环境
```
Ubuntu：22.04.2 LTS
geth1.9.12：1.9.12-stable
geth1：
    Version: 1.9.12-stable
    Git Commit: 27356db60e570e51169f6c763ff14eb41abc9e56
    Git Commit Date: 20210721
    Architecture: amd64
    Protocol Versions: [65 64 63]
    Go Version: go1.13.9
    Operating System: linux
```
#### 物理位置区块链概述
#### 1.9.12版本以太坊的节点启动
- 在任意位置新建`geth1.9.12_test/`（文件夹名根据个人情况而定）用于存放区块链相关数据，并进入该文件目录以该目录为工作区。
- 把geth1.9.12复制一份到当前文件夹方便操作，然后执行命令新建两个密码为`123456`的账户：
    ```
    > ./geth1.9.12 --datadir data1 account new       //0xc19DA0e6af14eF669E24003E8a9ae01797e424Aa
    > ./geth1.9.12 --datadir data1 account new       //0xd037DBF78fdff5C6045CED3DAeA6Ff4ECBE7C4Ba
    ```

    注意事项：
    - 若文件无法执行可以用`sudo chmod +x <文件>`为其添加执行权限

- 在工作区中新建创世配置文件[genesis.json](../../src/genesis_for_init_geth1.9.12_node/genesis.json)，文件内容如下：
    ```
    {
        "config": {
            "chainId": 12345,
            "homesteadBlock": 0,
            "eip150Block": 0,
            "eip155Block": 0,
            "eip158Block": 0,
            "byzantiumBlock": 0,
            "constantinopleBlock": 0,
            "petersburgBlock": 0,
            "istanbulBlock": 0,
            "ethash": {}
        },
        "difficulty": "1100000",
        "gasLimit": "8000000",
        "alloc字段的注释，geth在初始化时会忽略此字段": "将alloc中用户地址设置为刚刚生成的新用户的地址",
        "alloc": {
            "0xc19DA0e6af14eF669E24003E8a9ae01797e424Aa": { "balance":"500000000000000000000" },
            "0xd037DBF78fdff5C6045CED3DAeA6Ff4ECBE7C4Ba": { "balance":"400000000000000000000" }
        }
    }
    ```

    观察可以发现：
    - `difficulty`字段被设置成了之前在`step1_官方版本以太坊的使用`中难度自动调整到的1100000

- 使用创世配置文件进行创世
    ```
    > ./geth1.9.12 --datadir data1/ init genesis.json
    ```
- 启动私有链的第一个节点
    ```
    > ./geth1.9.12 --identity "geth1.9.12_test_node1" --networkid 11500 --datadir data1 --rpc --rpcaddr "127.0.0.1" --rpcport "8545" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30303 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1.9.12_node1_output.log
    ```

    观察可以发现：
    - 老版本以太坊使用`--rpc`表示HTTP-RPC服务而不是新版本中的`--http`
    - 相比于新版没有`--authrpc`服务故无需此参数
    - 老版本可以正常使用`personal`API故不需要`--rpc.enabledeprecatedpersonal`参数
    - 若无特殊说明后续操作默认在物理位置区块链上进行，启动该版本的以太坊节点仅仅为了观察二者的某些异同，加深理解
#### 物理位置区块链的节点启动
- 在任意位置新建`geth1_test/`（文件夹名根据个人情况而定）用于存放区块链相关数据，并进入该文件目录以该目录为工作区。
- 把geth1复制一份到当前文件夹方便操作，然后执行命令新建两个密码为`123456`的账户：
    ```
    > ./geth1 --datadir data1 account new       //0x14aFcb6F973d7536E0F6546E2EAf07809d7fbB1D
    > ./geth1 --datadir data1 account new       //0x00DA7F80Cf9a6711d023942B77FcE0aC92770b7B
    ```
- 在工作区中新建创世配置文件[genesis.json](../../src/genesis_for_init_geth1_node/genesis.json)，文件内容如下：
    ```
    {
        "config": {
            "chainId": 12345,
            "homesteadBlock": 0,
            "eip150Block": 0,
            "eip155Block": 0,
            "eip158Block": 0,
            "byzantiumBlock": 0,
            "constantinopleBlock": 0,
            "petersburgBlock": 0,
            "istanbulBlock": 0,
            "ethash": {}
        },
        "difficulty": "1100000",
        "gasLimit": "8000000",
        "alloc字段的注释，geth在初始化时会忽略此字段": "将alloc中用户地址设置为刚刚生成的新用户的地址",
        "alloc": {
        "0x14aFcb6F973d7536E0F6546E2EAf07809d7fbB1D": {
            "balance":"500000000000000000000",
            "position":"test0123456789",
            "txtime":1
        },
        "0x00DA7F80Cf9a6711d023942B77FcE0aC92770b7B": {
            "balance":"400000000000000000000",
            "position":"test1123456789",
            "txtime":2
        }
        }
    }
    ```

    观察可以发现：
    - 多了……（待补充）

- 使用创世配置文件进行创世
    ```
    > ./geth1 --datadir data1 init genesis.json
    ```
- 启动私有链的第一个节点
    ```
    > ./geth1 --identity "geth1_test_node1" --networkid 11600 --datadir data1 --rpc --rpcaddr "127.0.0.1" --rpcport "8546" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30304 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1_node1_output.log
    ```

    注意事项：
    - `--networkid`更换成11600为了区别geth1.9.12形成的网络（非必须）
    - `--rpcport`和`--port`更换，避免和本机上的geth1.9.12冲突
#### 节点基本操作
- 查看账户余额及当前位置
    ```
    > eth.accounts
    > eth.getBalance(eth.accounts[0])
    > eth.getPosition(eth.accounts[0])
    ```
- 查看节点创世区块信息
    ```
    > eth.blockNumber
    > eth.getBlock(0)
    ```

    观察可以发现：
    - geth1相比于geth1.9.12，区块多了一些字段（解释待补充）
        - `blockType`
        - `firestBB`
        - `parallelHash`
        - `regionId`
        - `regionRoot`
#### 多节点的加入
- <Ctrl+D>退出节点1，使用和节点1相同的创世配置文件对另外三个节点进行创世，另外三个节点的数据分别存储在`data2/`、`data3/`、`data4/`中
    ```
    > ./geth1 --datadir data2 init genesis.json
    > ./geth1 --datadir data3 init genesis.json
    > ./geth1 --datadir data4 init genesis.json
    ```
- 分别在不同终端下启动四个节点
    ```
    > ./geth1 --identity "geth1_test_node1" --networkid 11600 --datadir data1 --rpc --rpcaddr "127.0.0.1" --rpcport "8546" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30304 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1_node1_output.log
    > ./geth1 --identity "geth1_test_node2" --networkid 11600 --datadir data2 --rpc --rpcaddr "127.0.0.1" --rpcport "8547" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30305 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1_node2_output.log
    > ./geth1 --identity "geth1_test_node3" --networkid 11600 --datadir data3 --rpc --rpcaddr "127.0.0.1" --rpcport "8548" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30306 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1_node3_output.log
    > ./geth1 --identity "geth1_test_node4" --networkid 11600 --datadir data4 --rpc --rpcaddr "127.0.0.1" --rpcport "8549" --rpcapi "eth,net,personal,web3" --rpccorsdomain "*" --port 30307 --maxpeers 3 --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> geth1_node4_output.log
    ```
- 分别查看四个节点的基本基本信息并记录下enode字段的值
    ```
    > admin.nodeInfo
    //节点1的enode
    //"enode://dad184c888a6e4fcbc703d24d2d9d941104d0743ba2029638453cd69df7b350a9feeb95a1e4f69335bc946dbcd642664f4885117b82f29806df212111b401d5f@127.0.0.1:30304?discport=0"
    //节点2的enode
    //"enode://15a1a2c24fc4ba92177121146a9fc0ccb6ae31705458b17558b05ab909cebcb10b9cdfdbc34e16a3afd820e36e0752a59c7b34a1509c3dc726ef491c866fab23@127.0.0.1:30305?discport=0"
    //节点3的enode
    //"enode://4394d675a145a2b187999ea5a0aae931b2e875871c96949ad97ab5bc6ef61b4322d646348ff730adc0ca147923787d7bfd64b5dd11d5f7a6d28ae42ab67ecc65@127.0.0.1:30306?discport=0"
    //节点4的enode
    //"enode://4953f0713cabc9f2f2150b095fed33f48fc1a6b1962d226ca62ab03346e492162c585d507ab9fb77b81cac284ac46c894359e757a3e18799c7cdab2bd2efb8e1@127.0.0.1:30307?discport=0"
    ```
    > 此处有一个疑问，参见本部分最后`悬而未决的问题`
- 将节点2添加到节点1的静态节点列表中，然后再将节点3添加到节点1的静态节点列表中
    ```
    > admin.addPeer("enode://15a1a2c24fc4ba92177121146a9fc0ccb6ae31705458b17558b05ab909cebcb10b9cdfdbc34e16a3afd820e36e0752a59c7b34a1509c3dc726ef491c866fab23@127.0.0.1:30305?discport=0")
    > admin.addPeer("enode://4394d675a145a2b187999ea5a0aae931b2e875871c96949ad97ab5bc6ef61b4322d646348ff730adc0ca147923787d7bfd64b5dd11d5f7a6d28ae42ab67ecc65@127.0.0.1:30306?discport=0")
    ```

    观察可以发现：
    - 节点1只和节点2建立了静态链接，符合预期（详细请参考step1中相应的步骤）

- 进行5分钟的挖矿
    ```
    > miner.start();admin.sleep(300);miner.stop();
    ```

    观察可以发现：
    - 节点1和节点2的控制台同步输出处块成功通知（节点2的块是同步来的）
- <Ctrl+D>关闭节点2，观察节点1和节点3的行为，节点1主动链接了节点3，节点3同步了节点1中的区块
- 将节点4添加到节点3的静态节点列表中
    ```
    > admin.addPeer("enode://4953f0713cabc9f2f2150b095fed33f48fc1a6b1962d226ca62ab03346e492162c585d507ab9fb77b81cac284ac46c894359e757a3e18799c7cdab2bd2efb8e1@127.0.0.1:30307?discport=0")
    ```

    观察可以发现：
    - 节点3链接了1、4两个节点
    - 节点4完成了对节点3的同步
- 在节点1中解锁账户并查看账户余额并发起一个转账交易
    ```
    > eth.accounts[0]       //0x14afcb6f973d7536e0f6546e2eaf07809d7fbb1d
    > eth.accounts[1]       //0x00da7f80cf9a6711d023942b77fce0ac92770b7b
    > personal.unlockAccount(eth.accounts[0],"123456",0)
    > web3.fromWei(eth.getBalance(eth.accounts[0]),'ether')
    > web3.fromWei(eth.getBalance(eth.accounts[1]),'ether')
    > eth.sendTransaction({
        from:"0x14afcb6f973d7536e0f6546e2eaf07809d7fbb1d",
        to: eth.accounts[1],
        gasPrice:"19904412217",
        value:web3.toWei(10,"ether")
    })
    ```

    观察可发现：
    - 节点1、3、4的交易池中均出现了待上链的转账交易（使用`txpool`查看），符合预期
- 在节点4中新建一个矿工账户，后执行挖矿操作
    ```
    > personal.newAccount("123456")         //0x403b36a2cc74dcf787300ccc4fbad7ac288bbd2c
    > miner.setEtherbase("0x403b36a2cc74dcf787300ccc4fbad7ac288bbd2c")
    > miner.start(1);admin.sleepBlocks(1);miner.stop();
    ```

    观察可以发现：
    - 交易成功上链
    - 节点1、3、4保持同步
    - 更多信息在`step1`中已经观察过，此处不再赘述
#### 本部分悬而未决的问题
- 观察节点信息的时候发现`network`字段是经过编码的而不是原始的数字，原因尚不明确