> 本小节最后一次复现成功的时间：2023.02
#### 确认环境
```
Ubuntu：22.04.2 LTS
geth：1.11.5-stable
```
#### gethJS控制台概述
> 我们在控制台内可以使用：  
> 1. 所有以太坊源码中提供的[执行api](https://ethereum.github.io/execution-apis/api-documentation/)，也可以在[这里](https://ethereum.org/en/developers/docs/apis/json-rpc/)找到它们，执行api的github仓库在[这里](https://github.com/ethereum/execution-apis)。
> 2. geth额外的管理api例如`admin`，geth提供的所有api见[官方文档](https://geth.ethereum.org/docs/interacting-with-geth/rpc)
> 3. Web3js库的子集。由于geth使用的web3js库**不随该库的官方更新而更新**，可以在控制台内使用`web3.version`查看当前geth使用的web3js库版本。若[web3js官方文档](https://web3js.readthedocs.io/en/v1.8.2/)没有对应版本的文档，就去[web3js的github仓库](https://github.com/web3/web3.js)上寻找老版本的分支，并找到其指导文档。笔者所用的geth1.11.5支持0.2.1版本的web3js库，其仓库地址在[这里](https://github.com/web3/web3.js/tree/0.2.1)，readme中提供了[0.2x.x版本的指导文档](https://github.com/web3/web3.js/blob/0.20.7/DOCUMENTATION.md)的地址
#### 查看本地账户检查初始资金是否被正确分配
```
> eth.accounts
> personal.listAccounts       //不建议使用，新版geth已经弃用该模块
> eth.getBalance(eth.accounts[0])     //300000wei
> eth.getBalance(eth.accounts[1])     //400000wei
> web3.fromWei(eth.getBalance(eth.accounts[0]),'ether')  //单位是ether（以太币）
```

注意事项：
- 在控制台中直接查看的账户均为节点本地账户而不是区块链上记录的全部账户，之所以叫节点本地账户是因为这些账户的私钥信息储存在本节点

#### 创建账户并为账户设置各自的账户密码
```
> personal.newAccount("123456")
> personal.newAccount("123456")
> personal.newAccount("123456")
> eth.accounts
```

观察可以发现：
- data1/keystore/中多了三个存放账户私钥等信息的文件
- 此时本地节点存储了5个以太坊账户，账户余额分别为300000、400000、0、0、0（单位是Wei）

#### 将账户三指定为挖矿受益账户（矿工账户）
```
> eth.coinbase          
//Error: etherbase must be explicitly specified
> miner.setEtherbase(eth.accounts[2])
//true
> eth.coinbase == eth.accounts[2]
//true
```

注意事项：
- 该指定在重启节点后失效，需要重新指定

#### 尝试挖矿1：2个线程挖矿，挖10块
```
> miner.start(2);admin.sleepBlocks(10);miner.stop();
> eth.blockNumber
> web3.fromWei(eth.getBalance(eth.accounts[2]),'ether')
```

观察可以发现：
- 出块奖励是两个以太币
- 初始难度设置的很低所以出块速度很快

注意事项：
- 出块数量可能大于10块，因为admin.sleepBlocks(10)只能保证挖出的块不少于10个。若出块速度过快或者有多个线程同时在挖矿它可能来不及检测，观察日志发现该函数大概每30微秒检测一次

#### 尝试挖矿2：全力挖30分钟，完成后查看各区块的信息
```
> miner.start();admin.sleep(1800);miner.stop();
> eth.blockNumber
> eth.getBlock(0)
> eth.getBlock(100)
> eth.getBlock(500)
> eth.getBlock(501)
> eth.getBlock(502)
> eth.getBlock(2000)
> eth.getBlock(eth.blockNumber)
```

观察可以发现：
- 日志输出正常的挖矿信息，例如`Commit new mining work`
- 由于初始难度设置的较低，出块时间远小于以太坊15秒的目标。但是挖矿难度随着挖矿的进行而增大，出块时间趋于正常
- 子区块的`parentHash`是父区块的`hash`
- `receiptsRoot`（收据树）和`transactionsRoot`（交易树）因为没有新交易上链而保持不变
- 没有带有叔叔区块的区块，所有区块`sha3Uncles`相同
- 由于矿工账户得到了出块奖励所以各区块`stateRoot`（状态树）不同

注意事项：
- 我这里一共挖出了4000多个区块
- 挖矿难度最终达到了1042567，以后测试时可以在创世配置里设置难度为这个值

#### 使用创建账户时设置的密码解锁全部账户。
```
> personal.unlockAccount(eth.accounts[0],"123456",0)
> personal.unlockAccount(eth.accounts[1],"123456",0)
> personal.unlockAccount(eth.accounts[2],"123456",0)
> personal.unlockAccount(eth.accounts[3],"123456",0)
> personal.unlockAccount(eth.accounts[4],"123456",0)
```

指令说明：
- `personal.unlockAccount`使用用户设置的密码将公钥（地址）的对应私钥解密后放入内存
- 第三个参数是持续时间，默认是300秒如果设置为0则持续解锁直到节点关闭

注意事项：
- 要发起交易前必须解锁账户

#### 交易测试——发起交易：发起账户3到账户4的两个以太币转账两次并查看交易池中的交易信息
```
> web3.fromWei(eth.getBalance(eth.accounts[2]),'ether')
> web3.fromWei(eth.getBalance(eth.accounts[3]),'ether')
> eth.sendTransaction({
    from:eth.accounts[3],
    to:eth.accounts[4],
    value:web3.toWei(2,"ether")
})
> eth.sendTransaction({
    from:eth.accounts[2],
    to:eth.accounts[3],
    value:web3.toWei(2,"ether")
})
> txpool
> web3.fromWei(eth.getBalance(eth.accounts[2]),'ether')
> web3.fromWei(eth.getBalance(eth.accounts[3]),'ether')
```

观察可以发现：
- `txpool.inspect.pending`中多了一个以账户三地址作为key的键值对
- 键值对的值为账户三当前在交易池中的两个待提交的交易，交易大致由`账户的nonce值:"收款人:转账金额+汽油费"`构成
- 两个交易分别对应账户三的第一/二笔交易（nonce值是1和2）

注意事项：
- 只是发起这个交易，该交易尚未被打包进区块，账户1、2余额不发生变化
- 可以用`eth.pendingTransactions[index]`获取到某个待提交交易的具体信息

#### 尝试挖矿3：打包交易并查看账户余额
```
> eth.blockNumber()
> miner.start(1);admin.sleepBlocks(1);miner.stop();
> eth.blockNumber()
> web3.fromWei(eth.getBalance(eth.accounts[2]),'ether')
> web3.fromWei(eth.getBalance(eth.accounts[3]),'ether')
> eth.getBlock(eth.blockNumber)       
```

观察可以发现：
- 账户3以太币不变，支付两个以太币得到两个以太币的出块奖励，作为矿工接收了自己为交易支付的汽油费
- 账户4多了两个以太币
- 新区块的`transaction`字段包含刚刚发起的交易，交易上链成功