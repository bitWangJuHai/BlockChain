本部分最后一次复现成功的时间：2023.03
#### 确认环境
```
Ubuntu：22.04.2 LTS
geth：1.11.5-stable
```
#### 在节点1上查看当前私链的区块数，并为新协议配置的调度硬分叉（非必要，仅供学习）
- 查看当前区块数量
    ```
    > eth.blockNumber         //4266
    ```
- 在工作区中新建[genesis.json](../../src/genesis_for_init_node/genesis.json)，其内容如下：
    ```
    {
        "config": {
            "chainId": 12345,
            "homesteadBlock": 0,
            "eip150Block": 0,
            "eip155Block": 0,
            "eip158Block": 0,
            "byzantiumBlock": 0,
            "constantinopleBlock": 0,
            "petersburgBlock": 0,
            "istanbulBlock": 0,
            "berlinBlock": 0,
            "londonBlock": 5000,
            "ethash": {}
        },
        "difficulty": "1",
        "gasLimit": "8000000",
        "alloc": {
            "0x1CE69B3512147Dbc5f1C1A931014Ee2e92d1DDeD": { "balance": "300000" },
            "0xdf0fCfCAa6C816b09A8Ee22FEFe7C076650A7A51": { "balance": "400000" }
        }
    }
    ```

    字段说明：
    - `config.londonBlock`：指定该链从第几个区块开始遵守伦敦协议

    注意事项：
    - 节点1已经经过初始化，`config`以外的字段请务必保持不变否则无法通过创世合法性校验，更多关于以太坊创世流程的内容请看[这里](https://learnblockchain.cn/2019/04/08/genesis/) 

#### 使用新配置重新配置节点1并对其余三个节点进行初始化
```
> geth --datadir data1 init genesis.json
> geth --datadir data2 init genesis.json
> geth --datadir data3 init genesis.json
> geth --datadir data4 init genesis.json
```

命令说明：
- 用init命令为节点1启用新的创世配置，并生成节点2、3、4的创世配置

注意事项：
- 为了更好地了解以太坊网络这里使用四个节点进行演示
- 四个节点必须使用**完全相同**的创世配置文件，这样才能被认为是运行同一条链，才可能成为对等节点

#### 分别在不同终端启动节点1、节点2、节点3和节点4
```
> geth --identity "test_node1"  --networkid 11500 --datadir data1 --http --http.addr 127.0.0.1 --http.port 8545 --http.api eth,net,web3 --rpc.enabledeprecatedpersonal --http.corsdomain "*" --authrpc.addr 127.0.0.1 --authrpc.port 8551   --port 30303 --maxpeers 3  --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> node1_output.log
> geth --identity "test_node2"  --networkid 11500 --datadir data2 --http --http.addr 127.0.0.1 --http.port 8546 --http.api eth,net,web3 --rpc.enabledeprecatedpersonal --http.corsdomain "*" --authrpc.addr 127.0.0.1 --authrpc.port 8552   --port 30304 --maxpeers 3  --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> node2_output.log
> geth --identity "test_node3"  --networkid 11500 --datadir data3 --http --http.addr 127.0.0.1 --http.port 8547 --http.api eth,net,web3 --rpc.enabledeprecatedpersonal --http.corsdomain "*" --authrpc.addr 127.0.0.1 --authrpc.port 8553   --port 30305 --maxpeers 3  --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> node3_output.log
> geth --identity "test_node4"  --networkid 11500 --datadir data4 --http --http.addr 127.0.0.1 --http.port 8548 --http.api eth,net,web3 --rpc.enabledeprecatedpersonal --http.corsdomain "*" --authrpc.addr 127.0.0.1 --authrpc.port 8554   --port 30306 --maxpeers 3  --nodiscover --allow-insecure-unlock --dev.period 1 --syncmode full --verbosity 6 console 2>> node4_output.log
```

注意事项：
- 四个节点不同的属性：`--identity`、`--http.port`、`--port`、`--authrpc.port`、`--datadir`、日志文件
- 四个节点相同的属性：`--networkid`

#### 分别查看四个节点的基本信息，并记录下enode字段的值
```
> admin.nodeInfo
//节点1的enode
//"enode://34e0cddd2ef1a9d153481f4d267dd62426abb541e9bad0f199365ae8d0f572734d4e659103f6f349a2f3ecd538432064a3e383caab3c0e80ffa702e5d181d4a8@127.0.0.1:30303?discport=0"
//节点2的enode
//"enode://2c78f49d79bb05070bbecb83308ce05c957343927282a24e157830d71c55fa8e5b621ac23bd83fee85117cf048f713a0e28ddd99a21dbfddad9a7aeacd0a5773@127.0.0.1:30304?discport=0" 
//节点3的enode
//"enode://c6bfc735f2c645a346a3d4cb66280c22fb2d840c208dca338fd5a636e422bd90ddb59823e6201d10b12165786bbc77422aa235f96790a6c908f70d9d8f84ad29@127.0.0.1:30305?discport=0"
//节点4的enode
//"enode://bf4ac0ad67082ff98fe0d89a83179d2366eb248fee49b7bcfa4036a4225e099153dfc9ee9ccd1c395ad369444d1e352cf0bb82cf43a6a3cda183b1856f1acf3b@127.0.0.1:30306?discport=0"
```

观察可以发现：  
- `name`字段是由`--identity`参数指定的
- 因为使用`--nodeiscover`禁用了对等发现机制，所以`ports.discovery`为0
- `protocols.eth.genesis`相同，表示创世配置相同
- `networkid`及`chainid`相同，表示四个节点运行在**同一**区块链网络中的**同一**条链上

注意事项：
- 请将笔者的endoe替换为自己对应节点的enode

#### 在节点1中使用admin.addPeer方法将节点2添加到其静态节点列表
```
> admin.addPeer("enode://2c78f49d79bb05070bbecb83308ce05c957343927282a24e157830d71c55fa8e5b621ac23bd83fee85117cf048f713a0e28ddd99a21dbfddad9a7aeacd0a5773@127.0.0.1:30304?discport=0")
```

注意事项：
- 使用`admin.addPeer`方法为节点添加的静态节点在该节点重启后失效，若希望重启后依然生效请使用[以太坊toml配置文件](https://geth.ethereum.org/docs/fundamentals/config-files)

#### 在节点1、2中分别查看peer状态及区块同步情况
```
> admin.peers
> eth.syncing
> eth.blockNumber
```

观察可以发现：
- 节点1和节点2成功建立了网络链接，其中节点1是发起链接outbound方（inbound:false），节点2是接受链接的inbound方（inbound:true）
- 节点1根据IP协议随机使用了本机未被占用的一个端口去链接远程端口，即节点2的TCP监听端口127.0.0.1:30304
- 节点1中的network.static字段为true表示该链接是静态的，说明节点2是节点1的静态节点。节点会不停地尝试和**至少一个**静态节点建立静态链接。
- 节点1、2建立链接后会自动同步区块链数据，使用`eth.syncing`查看节点同步状态，若返回fasle且区块数量一致则说明同步完成。其对应文档在[这里](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_syncing)

#### 在节点1中使用admin.addPeer方法将节点3、4添加到其静态节点列表并查看peer状态
```
> admin.addPeer("enode://c6bfc735f2c645a346a3d4cb66280c22fb2d840c208dca338fd5a636e422bd90ddb59823e6201d10b12165786bbc77422aa235f96790a6c908f70d9d8f84ad29@127.0.0.1:30305?discport=0")
> admin.addPeer("enode://bf4ac0ad67082ff98fe0d89a83179d2366eb248fee49b7bcfa4036a4225e099153dfc9ee9ccd1c395ad369444d1e352cf0bb82cf43a6a3cda183b1856f1acf3b@127.0.0.1:30306?discport=0")
> admin.peers
```

观察可以发现：
- 由于节点1已经和至少一个静态节点（节点2）建立链接，所以节点1不会尝试和其它静态节点建立链接，他仍然只有节点2一个peer

#### Ctrl+d退出节点2并查看节点1、3、4的链接情况
```
> admin.peers
> eth.syncing
> eth.blockNumber
```

观察可以发现：
- 节点1在没有任何一个静态节点peer的时候主动链接其它静态节点
- 节点1和节点3或节点4建立了1-2个静态链接。以太坊节点自动点添加静态节点的规则**好像**是随机的（待笔者阅读源代码再确认），在本实验的情况下节点1有时添加到节点3有时添加到节点4有时3、4节点均被添加。
- 和节点1建立过链接的节点完成了对节点1的同步

#### Ctrl+d重启节点1以清空其静态节点信息，添加若干静态节点使4个节点形成区块链网络
```
//节点2添加节点1
> admin.addPeer("enode://34e0cddd2ef1a9d153481f4d267dd62426abb541e9bad0f199365ae8d0f572734d4e659103f6f349a2f3ecd538432064a3e383caab3c0e80ffa702e5d181d4a8@127.0.0.1:30303?discport=0")
//节点3添加节点1
> admin.addPeer("enode://34e0cddd2ef1a9d153481f4d267dd62426abb541e9bad0f199365ae8d0f572734d4e659103f6f349a2f3ecd538432064a3e383caab3c0e80ffa702e5d181d4a8@127.0.0.1:30303?discport=0")
//节点4添加节点2、节点3
> admin.addPeer("enode://2c78f49d79bb05070bbecb83308ce05c957343927282a24e157830d71c55fa8e5b621ac23bd83fee85117cf048f713a0e28ddd99a21dbfddad9a7aeacd0a5773@127.0.0.1:30304?discport=0")
> admin.addPeer("enode://c6bfc735f2c645a346a3d4cb66280c22fb2d840c208dca338fd5a636e422bd90ddb59823e6201d10b12165786bbc77422aa235f96790a6c908f70d9d8f84ad29@127.0.0.1:30305?discport=0")
//节点1添加节点4
> admin.addPeer("enode://bf4ac0ad67082ff98fe0d89a83179d2366eb248fee49b7bcfa4036a4225e099153dfc9ee9ccd1c395ad369444d1e352cf0bb82cf43a6a3cda183b1856f1acf3b@127.0.0.1:30306?discport=0")
//节点2添加节点3
> admin.addPeer("enode://c6bfc735f2c645a346a3d4cb66280c22fb2d840c208dca338fd5a636e422bd90ddb59823e6201d10b12165786bbc77422aa235f96790a6c908f70d9d8f84ad29@127.0.0.1:30305?discport=0")
```

观察可以发现：
- 节点1有三个peer
- 节点2和节点3、节点4和节点3之间并未建立链接
- 若退出节点2节点4即发起链接节点3的静态链接

#### 在节点1中发起一个交易并启动挖矿
```
//在节点2中新建本地账户
> eth.accounts
> personal.newAccount("123456")           //"0x8a693f69a1c21eca664ab4c5245f44cc302bc747"
> eth.accounts

//在节点1中查看之前挖矿的收益账户的余额及地址
> web3.fromWei(eth.getBalance(eth.accounts[2]),'ether')   //8530
> eth.accounts[2]             //"0x57855f39d2d3674907c7bddf408281c46d43676f"

//分别查看四个节点的交易池，均为空
> txpool.status

//在节点1中解锁账户并由发起一个交易，付款方是节点1的coinbase账户，收款方是节点2新建的本地账户，重复该交易1次。
> personal.unlockAccount(eth.accounts[2],"123456",0)
> eth.sendTransaction({from:"0x57855f39d2d3674907c7bddf408281c46d43676f",to:"0x8a693f69a1c21eca664ab4c5245f44cc302bc747",gasPrice:"19904412217",value:web3.toWei(10,"ether")})  
> eth.sendTransaction({from:"0x57855f39d2d3674907c7bddf408281c46d43676f",to:"0x8a693f69a1c21eca664ab4c5245f44cc302bc747",gasPrice:"19904412217",value:web3.toWei(10,"ether")})  

//分别查看四个节点的交易池，均有两个处于pending状态的交易。查看这些交易
> txpool.status
> eth.pendingTransactions

//在节点3中新建本地账户，并指定为coinbase账户，随后开始挖矿
> personal.newAccount("123456")   //"0x75c9076ebe1c6da3965964400a15f47e7763e5ec"
> miner.setEtherbase(eth.accounts[0])
> eth.coinbase
> eth.blockNumber     //4266
> miner.start(1);admin.sleepBlocks(1);miner.stop()    
> eth.blockNumber     //4267

//在节点4中查看节点3coinbase账户的余额
> web3.fromWei(eth.getBalance("0x75c9076ebe1c6da3965964400a15f47e7763e5ec"),'ether')
```

观察结果发现：
- 交易发起账户余额由于支付了汽油费而存在零头
- 节点3的coinbase账户获得了两个以太比的出块奖励以及汽油费奖励
- 四个节点的状态是同步的

注意事项：
- 汽油费请设置的高一些以便其它节点顺利接收该交易，此处交易的汽油费设置为`19904412217wei`，是当前以太坊最新交易发起者提供的汽油费，以太坊的实时状态请看[这里](https://etherscan.io/)
- 由于节点1上的账户的密钥文件存放于节点1，无法在其他节点发起节点1上账户的转账操作，但是查询账户余额没有限制
- 若交易未被广播到网络请及时查看日志或参考本文`悬而未决的问题`部分

#### 本部分悬而未决的问题
- 节点有时会因为nonce较小而不广播交易，日志输出`Skipping transaction with low nonce`，重启之后问题消失但是并没有从根本上解决