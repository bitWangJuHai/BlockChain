# Blockstack: A Global Naming and Storage System Secured by Blockchain
## Abstract
&emsp;&emsp;区块链例如Bitcoin和Namecoin以及它们各自的P2P网络在过去几年被广泛使用已经展示出了作为去中心化命名系统的潜力。使用者可以注册易于人类理解的域名并安全地使用它们并且只有注册域名的特定私钥的拥有者可以改写并更新这个域名-地址对。理论上，很多分布式系统都可以使用区块链网络进行搭建，例如**new?**，一个分布式的DNS及PKI版本。然而，这个技术相对新且发展迅速，可用于指导设计及如何进行权衡的现有数据和经验是有限的。  
&emsp;&emsp;在这篇文章中，我们描述了我们操作一个基于Namecoin区块链的大型分布式PKI服务的经验。当我们在Namecoin上注册和更新超过33000个账户及200000条交易时遇到了大量需要克服的与网络可靠性、吞吐量及安全性有关的挑战。更进一步，我们讨论了我们是如何根据经验设计了这个叫做区块栈的基于区块链的新命名和存储系统。我们详细阐述了为什么我们为了这个新系统从Namecoin网络迁移到了Bitcoin网络以及这次迁移的操作经验。Blockstack作为一个开源软件发行并在近期为55000个使用者提供了一个生产用的PKI系统。
## Introduction
&emsp;&emsp;加密货币区块链以及他们的P2P网络的用处不仅仅局限于交换财产。它们提供了基于密码的可审计且仅可追加的账本，这些账本已经被用于构建新的去中心化的DNS和PKI，以及其它应用比如文件存储和文件时间戳系统。因为区块链没有用于判断信息可信与否的中心，所以可以在其上建立一种新的去中心化应用或服务，这种服务将用户对单一可信方例如一个DNS根服务器或一个根证书机构的依赖程度最小化。  
&emsp;&emsp;区块链网络已经吸引了大量来自爱好者、工程师及投资者的兴趣。事实上，在过去的几年里新兴的区块链公司总共收到了11亿美元的投资。随着迅速的资金注入，区块链基础设施部署的越来越快，它正在成为大众可用的去中心化系统及应用的基础设施。然而区块链网络的发展还处在早期阶段，可指导设计的现成数据较少。很多区块链的非金融应用意味着我们很需要一个可以安全地将可读域名绑定到任意值的命名系统。区块链给出了命名系统的全局共识方案并且提供了仅可追加的全局状态改动日志。作为全局日志的追加，人们只能在新的块中写入键值对。这个全局日志在逻辑上是中心化的（网络中的全部节点的状态相同），但是是以去中心化的方式组织的（没有权威中心控制该日志）。  
&emsp;&emsp;基于区块链的命名的去中心化性质带来了有意义的安全优势，但当代区块链在某些方面存在技术局限性。单个区块通常是几千个字节大小并不能容纳太多数据。更新和创建记录的延迟被区块链的写传播（数据同步）和领导选举方案（证明机制）限制，这些延迟通常在10-40分钟左右。每个周期的新操作被网络中节点的平均带宽限制（比特币当前平均每个周期有大约1500个新操作）。进一步来说，新节点需要在一开始就独立验证全局日志：随着系统运行，引导新节点加入系统的时间线性增加。  
&emsp;&emsp;尽管区块链遇到了一些可扩展性和性能方面的问题，我们仍然相信它能为构建安全的去中心化服务提供重要的基础设施。随着区块链的广泛使用，篡改区块链的成本也在增加，今天想要攻击一个大型区块链系统比如Bitcoin需要花掉数十亿美元。  
&emsp;&emsp;这些区块链的优势促使我们使用它搭建了一个去中心化的PKI系统。我们的系统允许使用者注册独一无二的易读的用户名和关联公钥，就像PGP加密，以及这些用户的其它数据。我们的PKI系统不需要任何中心可信任的部分。Namecoin是迄今为止最大的基于区块链的服务之一，这篇文章介绍了我们在它上面运行这个PKI系统的经验。我们还列出了我们为了在Namecoin网络上注册和更新超过33000个用户信息并发送超过200000条交易时所克服的挑战。  
&emsp;&emsp;我们在生产部署时发现了很多有趣的经验，我们观察并分析了以前没有被发现或记录的网络异常及安全问题。我们发现了一个严重的安全问题，这个问题会导致单一矿工持续掌握超过51%的Namecoin网络算力（关于51%算力攻击以及矿工的算力细节请看[35]）。51%算力攻击是区块链最严重的攻击之一，它严重影响了区块链的安全性及分布式特性。  
&emsp;&emsp;此外，我们在Namecoin网络上广播交易时还遇到了难以解决的网络问题。区块链网络的可靠性大体上依赖于监控及维护的频繁程度,以及运营这个网络的经济上的奖励。因此，出于安全及可靠性考虑，基于区块链的服务应该使用最大最安全的区块链，在撰写本文时，它就是Bitcoin区块链。  
&emsp;&emsp;我们的Namecoin经历促成了这个新的基于区块链的命名存储系统的设计和实现，我们把这个系统命名为Blockstack，它是基于比特币区块链的。不像先前的基于区块链的系统，Blockstack把它的控制部分和数据部分分开：它在区块链中只保存最小的元数据（数据哈希的状态转换）并为实际的存储体使用外部的数据存储。Blockstack通过使用检查点和跳过列表去限制新节点为了开始必须去检查的区块的集合，从而实现新节点的快速引导。我们已经将Blockstack开源[13]。  
&emsp;&emsp;修改像比特币这样的生产用分布式系统（添加它设计时没有考虑的功能）非常困难，特别是保证修改过的系统仍然能达成共识。对于Blockstack，我们拓展了区块链的单状态机模型至任意状态机且不需要底层区块链进行打破共识的更改（译者注：硬分叉）。在我们之前这么做是不常规的；诚然，过去三年来的标准做法是在比特币主链上做分叉去添加不同的功能。我们的Namecoin区块链的经验表明在一个新的小型的区块链上开展工作会导致安全问题（比如攻击这个网络的算力要求降低），应该尽可能的避免这么做。  
&emsp;&emsp;这篇文章主要有以下几点贡献：
- 我们首次进行了特币之外的区块链网络的安全及可靠性分析并发现了一个主要候补区块链，Namecoin，的严重安全问题，有一个矿工在几个月内持续占有超过51%的算力。
- 我们发现合并挖矿，一个受欢迎的保护小型区块链安全的方法，在实践中失效。目前用于区块链的全部算力不够支持多个安全链。
- 我们公布了Blockstack的逻辑分层设计——虚拟链，它为生产用区块链引入了新的功能而不需要对底层区块链进行任何打破共识的更改。
- 我们公布了一个迁移的框架，该框架可以在一个底层区块链发生故障时将其迁移至另外一个区块链。我们还公布了我们的生产系统从Namecoin迁移到Bitcoin的经验教训。这是第一次对运行在区块链上的生产系统进行跨链迁移。
## 2 Motivation and Background
&emsp;&emsp;在这部分，我们描述了我们搭建这个去中心的命名系统的动机并提供了区块链的相关研究背景。这篇文章中，我们使用naming system这个术语来表示（a）名字是易于人类阅读并且可以被任意挑选的，（b）名值对具有强所有权，也就是说它们可以被加密密钥对持有（译者注：名是用户名，值是公钥，数据与用户名和公钥绑定保证了安全性），以及（c）没有中心信任部分或者故障点（译者注：不会发生单点故障）。搭建同时具有这三条性质的命名系统根据Zooko三角[32]来说是不可能的（译者注：Zooko三角即命名系统不能同时保证安全、去中心化、易于人理解的）。大部分传统的命名系统具有这三个性质中的两个。Namecoin网络使用了一个基于区块链的方法提供了第一个同时满足三个性质的命名系统。
### 2.1 Background on Blockchains
&emsp;&emsp;区块链提供了一个公共可写的仅可追加的日志。对全局日志的写入，即交易，被组织成块，每个块作为写入原子将多个交易打包并写入日志。对全局日志的写需要以transaction fee的形式提供报酬。参与区块链网络的节点遵循选举协议以决定哪个节点将要写入下一个区块并收取相应的交易费。并不是所有网络中的节点都参与领导节点的选举。为了成为下一轮的领导者而努力计算的节点被称为矿工。每一轮的最开始，矿工开始解决依赖于最后一个块的新的计算问题，第一个解决这个问题的矿工将写入新区块。在Bitcoin网络中，这些计算问题的难度由协议自动调整以至于维持出块时间为10分钟。关于区块链如何工作以及节点如何达成共识的细节请看[14]。
### 2.2 Namecoin's Naming System
&emsp;&emsp;Namecoin是Bitcoin的第一个分支也是Bitcoin之外最古老的仍在运行区块链，截至2016年5月Namecoin的加密货币市值500万美元（加密货币的市值是其交易所的价值乘以现存的货币总数）。创建Namecoin的主要动机是建立一个备用的类DNS系统，该系统代替了将域名映射到DNS记录的区块链DNS根服务器[41]。由于区块链没有信任中心，一个基于区块链的DNS系统更难审查并且在不访问所有者相应的私钥的情况下无法访问其已经注册的域名[31]。由于工作量证明机制，更改存储在区块链中的已注册的名称需要极高的算力[8]。在我们的工作之前，常规的做法是从Bitcoin上进行一个新的分叉以推行新功能或修改相应的服务，这也是Namecoin的合适做法。  
&emsp;&emsp;就像传统DNS，注册一个新域名需要一定的成本。名称注册费防止用户注册大量实际上根本用不到的域名。在Namecoin系统中，注册费的收款方是一个称作“黑洞”的加密地址，付给该地址的费用无法被取回[31]。Namecoin定义了一个价格函数，用于确定注册域名的费用随时间的变化。Namecoin支持多个名称空间（像DNS中的TLDs），不同的命名空间具有相同的定价规则和域名到期时间。方便起见，d/命名空间用于域名。  
&emsp;&emsp;在Namecoin中，名称的注册采用二阶段提交的方法，用户首先预定一个域名哈希然后通过出示真实域名和相应的的地址来注册域名地址对。这么做是为了避免未经区块链确认的域名注册抢跑（译者注：防止有人在区块确认之前通过快速发送注册请求恶意抢夺域名）。在新产生36000个区块大概8个月后，注册的域名会失效。Namecoin也支持对名称所绑定的地址的更换以及名称所有权的转移。  
### 2.3 Blockchain-based PKI System
&emsp;&emsp;通过在Namecoin上使用一个新的u/命名空间，我们建立了一个PKI身份系统，我们把它称作Blockstack ID。就像PGP一样[53]，我们定义了公布公钥以及其它区块链配置数据的格式[3]。这和定义DNS记录（译者注：报文）的格式相似。Namecoin支持注册易于阅读的域名及域名地址对。Namecoin为每个域名地址对提供了有限的存储空间，我们通过使用域名地址对的链接列表扩展了存储容量。同时，为了我们的生产系统，我们提升了Namecoin的读取性能。  
&emsp;&emsp;在2014年3月，我们运行了一个允许用户在Namecoin内轻松注册u/命名空间内的域名的Web服务器[43]，并将配置文件与这些用户相关联。在我们的web服务器中，我们首先代表用户注册了域名（当然支付了注册费），然后将域名转移给用户拥有的加密货币地址。我们的实现是第一个使用区块链将用户身份绑定到公钥的生产用PKI系统（其它系统请看第6部分）。所有经过注册的域名默认有一个ECDSA公钥[28]，一部分用户还在信息中添加了PGP密钥。根据Harry et al的研究[31]，按照容量计算我们的命名空间在Namecoin网络是第二大的并且拥有最多的活跃用户数量。  
## 3 Lessons from Namecoin Deployment
&emsp;&emsp;在这部分，我们阐述了我们在Namecoin上运行生产系统一年来总结的经验以及我们面对的挑战。我们介绍了我们维护区块链安全（3.1、3.3、3.5），提升网络可靠性（3.2）以及部署硬分叉的经验教训。这些经验教训直接影响了我们的新系统，Blockstack，的设计。    
![Weekly and daily mining distribution]()  
### 3.1 Blockchain Security
&emsp;&emsp;域名所有权的保护和底层区块链及上层应用的安全息息相关。一个区块链最重要的安全要素是攻击（译者注：此处的攻击应该是指51%算力攻击）及篡改近期数据的成本。矿工经常集中他们的计算资源形成mining pool，它是一个网络中的超级节点（单个矿工具有大量的算力）。如果单个矿工或矿池拥有超过其它所有矿工的算力的总和，我们把它叫做51%攻击，如果这样那个矿工就有能力攻击这个网络，比如重写区块链的近期写入、审查交易（e.g.域名注册）并且可以使用双花攻击偷窃加密货币[49]。这是因为这个矿工将在大多数时间赢得记账权，通过比其他矿工提供更多的工作量证明这个矿工可以产生一个区块链历史记录。控制区块链上大部分算力的成本越高，这个区块链越安全。  
&emsp;&emsp;我们注意到2014年年末Namecoin上有一个单一矿池的算力一直拥有超过51%的算力。直到最近，这个情况变得更糟，某个矿池正在控制超过60%的Namecoin算力。图1展示了按周和日计算的2015年8月Namecoin的算力分布，就在我们迁移我们的系统之前。事实上，我们发现了F2Pool（也被叫做Discus Fish）在特定的某周控制了超过75%的算力。在这样的算力集中之下，Namecoin已经被网络中的单一部分控制了；F2Pool可以获得大部分新区快的记账权并可以破快区块链的安全性。除了哈希算力，软件bug也可以导致安全问题，比如Namecoin的一个bug允许用户从任何人那里偷窃域名。拒绝服务攻击（让服务器频大量理伪造的垃圾事务而不能处理正常事务）是另一种攻击模式；加密货币网络中的对等节点越多，网络抵御拒绝服务攻击的能力越强。  
&emsp;&emsp;Bitcoin目前拥有最大的算力以保护区块链数据。比特币的代码库更新活跃且发现bug的奖励也很丰厚。Namecoin比Bitcoin的节点数量少了很多（170vs4600在2016年1月[4]），这使Namecoin更容易收到DDos攻击（译者注：分布式拒绝服务攻击）。比特币区块链是目前最安全的区块链。然而在Bitcoin上添加新功能是极度困难的，因为那需要进行硬分叉（3.4部分）。  
&emsp;&emsp;**经验1：需要在区块链安全和为区块链添加新功能之间进行基本的权衡。**启动一个新的区块链网络是开发者添加Bitcoin没提供的功能的常用方式，例如许多新应用都感兴趣的域名系统。然而，新的区块链相比Bitcoin安全性严重不足。在第四部分，我们介绍了Blockstack是如何通过创建一个虚拟链来克服这个权衡的，这个虚拟链作为Bitcoin的上层提供了一些新功能。  
### 3.2 Network Reliablity and Throughput
&emsp;&emsp;PKI系统的吞吐量（注册更新的条目数量）直接取决于底层区块链的吞吐量。每小时可注册更新的操作的数量被底层区块链每小时可以处理及确认的交易数量限制。相似地，如果底层区块链不能稳定且可靠地处理操作，我们的PKI系统的可靠性也会受到影响。    
&emsp;&emsp;**Namecoin网络延迟峰值**：作为一个比特币的分叉，Namecoin和Bitcoin共享很多协议性质，包括出块时间10分钟（这就是峰值延迟）以及每个块限制在1MB的大小内（每个块大概1000个交易的吞吐量）。Figure 2(a)展示了自从我们在2014年3月开始在Namecoin上运行我们的KPI系统，Namecoin的网络延迟有所下降。正如期待的那样，大部分新区块在10到40分钟之内被写入区块链（Bitcoin也有相近的时间[14]）。Figure 2(b)展示了一个在2014年8月末发生的一个意外情况（在第192000区块），在几周之内网络延迟飙升（一周之内只有大约1000个区块上链）。在调查并和Namecoin的开发人员讨论过后，我们发现这个延迟峰值是由Namecoin上运行的应用程序问题导致的。网络上的某个节点在每个交易内添加了大量数据段，这给矿工造成了性能问题，它们的Namecoin守护程序不断崩溃。失去了稳定的矿工节点，区块就无法进行及时的追加。这表明了意料之外的协议或软件问题可能导致网络延迟。在这段时期之内，我们注意到我们的PKI系统的新注册率下降，用户投诉数量也同时激增。
